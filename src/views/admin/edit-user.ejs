<section class="py-5">
    <div class="container px-5 my-5">
        <div class="row gx-5">
            <div class="col-lg-12 mb-4">
                <h2 class="fw-bolder">Edit User: <%= editUser.username %></h2>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/blogs">Home</a></li>
                        <li class="breadcrumb-item"><a href="/admin/users">User Management</a></li>
                        <li class="breadcrumb-item active">Edit User</li>
                    </ol>
                </nav>
            </div>

            <div class="col-lg-8">
                <form action="/admin/users/<%= editUser._id %>?_method=PUT" method="POST">
                    <div class="card shadow-sm">
                        <div class="card-header">
                            <h5 class="mb-0">User Information</h5>
                        </div>
                        <div class="card-body">
                            <!-- Error Message -->
                            <% if (typeof error !== 'undefined') { %>
                                <div class="alert alert-danger">
                                    <%= error %>
                                </div>
                            <% } %>

                            <div class="mb-3">
                                <label for="username" class="form-label">Username <span class="text-danger">*</span></label>
                                <input type="text" name="username" class="form-control" id="username" 
                                       value="<%= editUser.username %>" required>
                                <div class="form-text">Username must be unique and contain only letters, numbers, and underscores.</div>
                            </div>

                            <div class="mb-3">
                                <label for="email" class="form-label">Email Address <span class="text-danger">*</span></label>
                                <input type="email" name="email" class="form-control" id="email" 
                                       value="<%= editUser.email %>" required>
                                <div class="form-text">Email must be unique and valid.</div>
                            </div>

                            <div class="mb-3">
                                <label for="newPassword" class="form-label">New Password</label>
                                <input type="password" name="newPassword" class="form-control" id="newPassword">
                                <div class="form-text">Leave blank to keep current password. Must be at least 6 characters if changed.</div>
                            </div>

                            <div class="mb-3">
                                <label for="confirmNewPassword" class="form-label">Confirm New Password</label>
                                <input type="password" name="confirmNewPassword" class="form-control" id="confirmNewPassword">
                                <div class="invalid-feedback">
                                    Passwords do not match.
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="isAdmin" class="form-label">User Role</label>
                                <select class="form-select" name="isAdmin" id="isAdmin">
                                    <option value="false" <%= !editUser.isAdmin ? 'selected' : '' %>>Regular User</option>
                                    <option value="true" <%= editUser.isAdmin ? 'selected' : '' %>>Administrator</option>
                                </select>
                                <div class="form-text">
                                    <strong>Warning:</strong> Administrators have full access to all system features including user management.
                                </div>
                            </div>
                        </div>
                        <div class="card-footer">
                            <div class="d-flex justify-content-between">
                                <a href="/admin/users" class="btn btn-outline-secondary">
                                    <i class="bi bi-arrow-left"></i> Cancel
                                </a>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-save"></i> Update User
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            
            <div class="col-lg-4">
                <div class="card shadow-sm mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">User Details</h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <strong>User ID</strong>
                                <span class="text-muted"><%= editUser._id %></span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <strong>Created</strong>
                                <span class="text-muted"><%= new Date(editUser.createdAt).toLocaleDateString('vi-VN') %></span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <strong>Last Updated</strong>
                                <span class="text-muted"><%= new Date(editUser.updatedAt).toLocaleDateString('vi-VN') %></span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <strong>Current Role</strong>
                                <% if (editUser.isAdmin) { %>
                                    <span class="badge bg-danger">Admin</span>
                                <% } else { %>
                                    <span class="badge bg-secondary">User</span>
                                <% } %>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="card shadow-sm mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Quick Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <a href="/admin/users/<%= editUser._id %>" class="btn btn-outline-info">
                                <i class="bi bi-eye"></i> View Details
                            </a>
                            <% if (editUser._id.toString() !== user.userId) { %>
                                <form action="/admin/users/<%= editUser._id %>?_method=DELETE" method="POST" style="display: inline;">
                                    <button type="submit" class="btn btn-outline-danger w-100" 
                                        onclick="return confirm('Are you sure you want to delete this user? This action cannot be undone.')">
                                        <i class="bi bi-trash"></i> Delete User
                                    </button>
                                </form>
                            <% } %>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0">Important Notes</h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled mb-0">
                            <li class="mb-2">
                                <i class="bi bi-info-circle text-info me-2"></i>
                                Leave password blank to keep current
                            </li>
                            <li class="mb-2">
                                <i class="bi bi-shield-exclamation text-warning me-2"></i>
                                Admin role grants full system access
                            </li>
                            <li class="mb-2">
                                <i class="bi bi-exclamation-triangle text-danger me-2"></i>
                                You cannot delete your own account
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const newPasswordField = document.getElementById('newPassword');
    const confirmNewPasswordField = document.getElementById('confirmNewPassword');
    const form = document.querySelector('form');

    // Password confirmation validation
    function validatePasswordMatch() {
        const newPassword = newPasswordField.value;
        const confirmNewPassword = confirmNewPasswordField.value;
        
        // Only validate if a new password is entered
        if (newPassword || confirmNewPassword) {
            if (newPassword !== confirmNewPassword) {
                confirmNewPasswordField.setCustomValidity('Passwords do not match');
                confirmNewPasswordField.classList.add('is-invalid');
            } else {
                confirmNewPasswordField.setCustomValidity('');
                confirmNewPasswordField.classList.remove('is-invalid');
            }
        } else {
            confirmNewPasswordField.setCustomValidity('');
            confirmNewPasswordField.classList.remove('is-invalid');
        }
    }

    confirmNewPasswordField.addEventListener('input', validatePasswordMatch);
    newPasswordField.addEventListener('input', validatePasswordMatch);

    // Form validation
    form.addEventListener('submit', function(event) {
        validatePasswordMatch();
        
        if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
        }
        
        form.classList.add('was-validated');
    });

    // Password strength indicator for new password
    newPasswordField.addEventListener('input', function() {
        const password = this.value;
        if (password.length > 0) {
            const strength = getPasswordStrength(password);
            showPasswordStrength(strength);
        } else {
            hidePasswordStrength();
        }
    });

    function getPasswordStrength(password) {
        let score = 0;
        if (password.length >= 8) score++;
        if (/[a-z]/.test(password)) score++;
        if (/[A-Z]/.test(password)) score++;
        if (/[0-9]/.test(password)) score++;
        if (/[^A-Za-z0-9]/.test(password)) score++;
        return score;
    }

    function showPasswordStrength(strength) {
        const strengthTexts = ['Very Weak', 'Weak', 'Fair', 'Good', 'Strong'];
        const strengthColors = ['danger', 'warning', 'warning', 'info', 'success'];
        
        let strengthIndicator = document.getElementById('password-strength');
        if (!strengthIndicator) {
            strengthIndicator = document.createElement('div');
            strengthIndicator.id = 'password-strength';
            strengthIndicator.className = 'form-text';
            newPasswordField.parentNode.appendChild(strengthIndicator);
        }
        
        strengthIndicator.innerHTML = `Password strength: <span class="text-${strengthColors[strength]}">${strengthTexts[strength]}</span>`;
    }

    function hidePasswordStrength() {
        const strengthIndicator = document.getElementById('password-strength');
        if (strengthIndicator) {
            strengthIndicator.innerHTML = '';
        }
    }
});
</script>